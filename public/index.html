<!DOCTYPE html>
<html>
<head>
    <title>Stella</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.19/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.19/themes/flick/jquery-ui.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.19/i18n/jquery-ui-i18n.min.js"></script>
    
    <script type="text/javascript" src="./javascripts/knockout-2.2.0.js"></script>
    
    <script type="text/javascript">
    //contenteditable
    ko.bindingHandlers.htmlValue = {
        init: function(element, valueAccessor, allBindingsAccessor) {
            ko.utils.registerEventHandler(element, "blur", function() {
                var modelValue = valueAccessor();
                var elementValue = element.innerHTML;
                if (ko.isWriteableObservable(modelValue)) {
                    modelValue(elementValue);
                } else { //handle non-observable one-way binding
                    var allBindings = allBindingsAccessor();
                    if (allBindings['_ko_property_writers'] && allBindings['_ko_property_writers'].htmlValue) allBindings['_ko_property_writers'].htmlValue(elementValue);
                }
            });
        },
        update: function(element, valueAccessor) {
            var value = ko.utils.unwrapObservable(valueAccessor()) || "";
            element.innerHTML = value;
        }
    };
    
    //draggable
    ko.bindingHandlers.positionOffset = {
        init: function (element, valueAccessor) {
            var position = ko.utils.unwrapObservable(valueAccessor());
            jQuery(element).draggable({
                handle: '>.drag-handle',
                drag: function (e, ui) {
                    position.left(ui.position.left);
                    position.top(ui.position.top);
                }
            }).css({
                left: position.left(),
                top: position.top()
            });
        },
        update: function(element, valueAccessor) {
            var position =  ko.utils.unwrapObservable(valueAccessor());
            if (typeof (position) === 'function') {
                position = position();
            }
            jQuery(element).css({left: position.left, top: position.top});
        }
    }
        
    </script>
    
    <!-- special web fonts -->
    <link href='http://fonts.googleapis.com/css?family=Oleo+Script+Swash+Caps:bold&effect=shadow-multiple&text=Stella' rel='stylesheet' type='text/css'>
    
    <link rel="stylesheet" href="./stylesheets/main.css">
    
</head>
<body>
<div class="header">
    <h1 class="app-title font-effect-shadow-multiple" style="font-family: 'Oleo Script Swash Caps', cursive">Stella</span></h1>
    <button id="project-save-button" data-bind="click: save">Save</button>
</div>

<div id="main" class="stella-view">
    
    <div class="workspace">
        <!-- ko foreach: scenes -->
            <div class="index-card scene-container">
                <div class="ui-widget-header scene-title">
                    <span data-bind="visible: !titleEditing(), text: title">&nbsp;</span>
                    <a href="#" data-bind="visible: !titleEditing(), click: editTitle">edit</a>
                    <input data-bind="visible: titleEditing, value: title, hasfocus: titleEditing" />
                </div>
                <div class="scene-body">
                    <div class="scene-content" contenteditable="true" data-bind="htmlValue:content"></div>
                </div>
            </div>
        <!--/ko -->
        
        <div style="-webkit-column-break-after: always;"></div>
        
        <div data-bind="foreach: annotations">
            <div class="annotation-container"  data-bind="positionOffset: position">
                <div contenteditable="true" data-bind="htmlValue:content"></div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="./javascripts/main.js"></script>
</body>
</html>